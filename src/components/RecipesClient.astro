---
import Recipe from "./Recipe.astro"
import Chip from "./Chip.astro"
import SearchBar from "./SearchBar"
import "../pages/_recipes.scss"

interface Props {
  recipes: any[]
}

const { recipes } = Astro.props

const normalizeRecipe = (recipe: any) => ({
  ...recipe,
  tags: Array.isArray(recipe.tags)
    ? recipe.tags.map((tag: string) => tag.toLowerCase())
    : [],
})

const combinedRecipes = recipes.map(normalizeRecipe)

// Shuffle
for (let i = combinedRecipes.length - 1; i > 0; i--) {
  const j = Math.floor(Math.random() * (i + 1))
  ;[combinedRecipes[i], combinedRecipes[j]] = [
    combinedRecipes[j],
    combinedRecipes[i],
  ]
}

// Get all unique tags
const allTags = new Set(combinedRecipes.flatMap((recipe) => recipe.tags || []))
---

<div id="recipes-container">
  <div class="searchContainer">
    <SearchBar client:idle />
  </div>
  <div class="chips" id="tag-chips">
    {
      [...allTags]
        .sort()
        .map((tag) => <Chip label={tag} data-tag={tag} active={false} />)
    }
  </div>
  <div class="recipes" id="recipes-list">
    {
      combinedRecipes.map((recipe) => (
        <div
          class="recipe-wrapper"
          data-recipe-id={recipe.id}
          data-recipe-title={recipe.title.toLowerCase()}
          data-recipe-tags={JSON.stringify(recipe.tags)}
        >
          <Recipe
            title={recipe.title}
            image={recipe.image}
            source={recipe.source}
            tags={recipe.tags}
            notes={recipe.notes}
            type={recipe.type}
            slug={recipe.slug}
            tagFilters={[]}
          />
        </div>
      ))
    }
  </div>
</div>

<style>
  .recipe-wrapper {
    opacity: 0;
    transform: translateY(20px);
    transition:
      opacity 0.3s ease-out,
      transform 0.3s ease-out;
  }

  .recipe-wrapper.visible {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script>
  import "../scripts/recipes-filter.ts"
</script>
